<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía Interactiva: APEX y Dashboard Dinámico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Source+Code+Pro:wght@400;500&display=swap');
        .font-code {
            font-family: 'Source Code Pro', monospace;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
        }
        .nav-link.active {
            background-color: #eab308; /* yellow-500 */
            color: #1e293b; /* slate-800 */
            font-weight: 700;
        }
        .code-block {
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #475569;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        .code-block:hover .copy-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-5xl font-bold text-slate-900">Guía Interactiva: APEX y Dashboard Dinámico</h1>
            <p class="mt-2 md:mt-4 text-lg text-slate-600 max-w-3xl mx-auto">Una transformación de la guía estática a una experiencia interactiva para crear una aplicación en Oracle APEX con autenticación y roles.</p>
                                    <li><a href="../index.html" class="nav-link text-left w-full p-3 rounded-lg transition-colors duration-200 block nav-link active">Regresar</a></li>
        </header>

        <div class="flex flex-col md:flex-row gap-8">
            <aside class="md:w-1/4">
                <nav id="step-navigation" class="sticky top-8">
                    <ul class="space-y-2">
                        <li><a href="#" class="nav-link text-left w-full p-3 rounded-lg transition-colors duration-200 block nav-link active" data-step="1">Paso 1: Crear la Tabla</a></li>
                        <li><a href="#" class="nav-link text-left w-full p-3 rounded-lg transition-colors duration-200 block" data-step="2">Paso 2: Insertar Datos</a></li>
                        <li><a href="#" class="nav-link text-left w-full p-3 rounded-lg transition-colors duration-200 block" data-step="3">Paso 3: Crear Aplicación</a></li>
                        <li><a href="#" class="nav-link text-left w-full p-3 rounded-lg transition-colors duration-200 block" data-step="3-1">Paso 3.1: Crear Items</a></li>
                        <li><a href="#" class="nav-link text-left w-full p-3 rounded-lg transition-colors duration-200 block" data-step="4">Paso 4: Configurar Autenticación</a></li>
                        <li><a href="#" class="nav-link text-left w-full p-3 rounded-lg transition-colors duration-200 block" data-step="5">Paso 5: Crear Dashboard</a></li>
                        <li><a href="#" class="nav-link text-left w-full p-3 rounded-lg transition-colors duration-200 block" data-step="6">Paso 6: Probar la Aplicación</a></li>
                    </ul>
                </nav>
            </aside>

            <main class="md:w-3/4 bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <div id="step-1" class="step-content active">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900">Paso 1: Crear la Tabla `personas`</h2>
                    <p class="mb-6 text-slate-600">El primer paso es definir la estructura que almacenará la información de los usuarios. Abre el **SQL Workshop** en tu espacio de trabajo de APEX, navega a **SQL Commands** y ejecuta el siguiente script para crear la tabla.</p>
                    <div class="code-block bg-slate-800 text-white rounded-lg p-4 font-code text-sm">
                        <button class="copy-btn">Copiar</button>
                        <pre><code>CREATE TABLE personas (
    id_persona    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nombre        VARCHAR2(100) NOT NULL,
    matricula     NUMBER(10),
    correo        VARCHAR2(100) NOT NULL UNIQUE,
    contraseña    VARCHAR2(100) NOT NULL,
    rol           VARCHAR2(20) NOT NULL CHECK (rol IN ('administrador', 'coach', 'directivo', 'aprendiz'))
);</code></pre>
                    </div>
                     <div class="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-r-lg">
                        <h4 class="font-bold">Nota sobre la seguridad</h4>
                        <p>Como se solicitó, la columna `contraseña` no utiliza hash. Para un entorno de producción, es crucial encriptar las contraseñas utilizando la función <strong>`APEX_AUTHENTICATION.HASH`</strong> para garantizar la seguridad de los datos.</p>
                    </div>
                </div>

                <div id="step-2" class="step-content">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900">Paso 2: Insertar Datos de Prueba</h2>
                    <p class="mb-6 text-slate-600">Para poder probar el sistema de inicio de sesión y los diferentes roles, es necesario insertar algunos registros de ejemplo. Ejecuta las siguientes sentencias en la misma ventana de **SQL Commands**.</p>
                    <div class="code-block bg-slate-800 text-white rounded-lg p-4 font-code text-sm">
                        <button class="copy-btn">Copiar</button>
                        <pre><code>INSERT INTO personas (nombre, matricula, correo, contraseña, rol) VALUES ('Admin User', NULL, 'admin@test.com', 'admin123', 'administrador');
INSERT INTO personas (nombre, matricula, correo, contraseña, rol) VALUES ('Coach Javier', 1234567890, 'coach@test.com', 'coach123', 'coach');
INSERT INTO personas (nombre, matricula, correo, contraseña, rol) VALUES ('Director Lopez', 9876543210, 'directivo@test.com', 'directivo123', 'directivo');
INSERT INTO personas (nombre, matricula, correo, contraseña, rol) VALUES ('Estudiante Ana', 111222333, 'aprendiz@test.com', 'aprendiz123', 'aprendiz');
INSERT INTO personas (nombre, matricula, correo, contraseña, rol) VALUES ('Visitante Luis', NULL, 'visitante@test.com', 'visitante123', 'visitante');

COMMIT;</code></pre>
                    </div>
                </div>

                <div id="step-3" class="step-content">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900">Paso 3: Crear la Aplicación en APEX App Builder</h2>
                    <p class="mb-6 text-slate-600">Con la tabla ya creada y poblada, el siguiente paso es crear la aplicación que la utilizará. Sigue estas instrucciones dentro de la interfaz de APEX.</p>
                    <ol class="list-decimal list-inside space-y-3 text-slate-700">
                        <li>Ve a <strong>App Builder</strong>.</li>
                        <li>Haz clic en <strong>Create</strong> y selecciona <strong>New Application</strong>.</li>
                        <li>Asigna un nombre a tu aplicación (por ejemplo, "Sistema de Gestión").</li>
                        <li>Haz clic en <strong>Create Application</strong> para finalizar.</li>
                        <li>Una vez creada, dentro de la aplicación, ve a <strong>Shared Components</strong> y busca <strong>Authentication Schemes</strong> en la sección "Security".</li>
                    </ol>
                </div>

                <div id="step-3-1" class="step-content">
                     <h2 class="text-2xl font-bold mb-4 text-slate-900">Paso 3.1: Crear los Application Items</h2>
                     <p class="mb-6 text-slate-600">Tu código utiliza los Application Items `:USER_ROLE` y `:APP_USER_ROLE`. Debes crearlos antes de configurar el esquema de autenticación. Estos son variables de sesión que puedes usar en cualquier parte de tu aplicación.</p>
                     <p class="mb-6 text-slate-600">En la misma página de <strong>Shared Components</strong>, ve a la sección <strong>Application Logic</strong> y haz clic en <strong>Application Items</strong>. Crea dos nuevos items con los siguientes nombres:</p>
                     <ul class="list-disc list-inside space-y-2 text-slate-700">
                         <li>`USER_ROLE`</li>
                         <li>`APP_USER_ROLE`</li>
                     </ul>
                </div>

                <div id="step-4" class="step-content">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900">Paso 4: Configurar el Esquema de Autenticación</h2>
                    <p class="mb-6 text-slate-600">Ahora que estás en la página `Edit Authentication Scheme`, completa los campos para configurar tu esquema de autenticación personalizado. El flujo es directo en una sola pantalla, como muestra tu captura.</p>
                     <ol class="list-decimal list-inside space-y-4 text-slate-700 mb-6">
                        <li>Llena los siguientes campos:
                            <ul class="list-disc list-inside ml-6 mt-2 bg-slate-100 p-4 rounded-lg space-y-2">
                                <li><strong>Name:</strong> `Custom Authentication Scheme`</li>
                                <li><strong>Scheme Type:</strong> `Custom`</li>
                                <li>En el campo <strong>Authentication Function Name</strong>, introduce el nombre de la función que vamos a crear en el siguiente paso: `authenticate_user`.</li>
                                <li>En el campo <strong>Post-Authentication Procedure Name</strong>, introduce el nombre del procedimiento que vamos a crear en el paso 4.2: `set_user_role`.</li>
                            </ul>
                        </li>
                    </ol>
                    <p class="mt-6 text-slate-600">Finalmente, haz clic en **Create Authentication Scheme**.</p>

                    <h3 class="text-xl font-bold mt-8 mb-4">4.1 Crear la Función de Autenticación</h3>
                    <p class="mb-4 text-slate-600">Regresa a **SQL Workshop** > **SQL Commands** y ejecuta el siguiente código. Esta función valida las credenciales y devuelve un booleano.</p>
                    <div class="code-block bg-slate-800 text-white rounded-lg p-4 font-code text-sm">
                        <button class="copy-btn">Copiar</button>
                        <pre><code>CREATE OR REPLACE FUNCTION authenticate_user (
    p_username IN VARCHAR2,
    p_password IN VARCHAR2
) RETURN BOOLEAN AS
    l_count NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO l_count
    FROM personas
    WHERE UPPER(TRIM(correo)) = UPPER(TRIM(p_username))
      AND contraseña = p_password;
    
    RETURN l_count = 1;
END;</code></pre>
                    </div>

                    <h3 class="text-xl font-bold mt-8 mb-4">4.2 Crear el Procedimiento de Post-Autenticación</h3>
                    <p class="mb-4 text-slate-600">Aún en **SQL Commands**, ejecuta este código para crear el procedimiento. Este se ejecutará automáticamente después de una autenticación exitosa para asignar el rol a los items de sesión.</p>
                    <div class="code-block bg-slate-800 text-white rounded-lg p-4 font-code text-sm">
                        <button class="copy-btn">Copiar</button>
                        <pre><code>CREATE OR REPLACE PROCEDURE set_user_role AS
    l_rol VARCHAR2(20);
    l_username VARCHAR2(100);
BEGIN
    l_username := APEX_CUSTOM_AUTH.GET_USERNAME;
    
    BEGIN
        SELECT rol
        INTO l_rol
        FROM personas
        WHERE UPPER(TRIM(correo)) = UPPER(TRIM(l_username));
        
        -- Si se encuentra un rol válido, lo asigna
        APEX_UTIL.SET_SESSION_STATE('USER_ROLE', l_rol);
        APEX_UTIL.SET_SESSION_STATE('APP_USER_ROLE', l_rol);
    EXCEPTION
        -- Si no se encuentra un rol (NO_DATA_FOUND), asigna un rol por defecto
        WHEN NO_DATA_FOUND THEN
            APEX_UTIL.SET_SESSION_STATE('USER_ROLE', 'invitado');
            APEX_UTIL.SET_SESSION_STATE('APP_USER_ROLE', 'visitante');
        -- Manejo de cualquier otro error
        WHEN OTHERS THEN
            APEX_UTIL.SET_SESSION_STATE('USER_ROLE', 'invitado');
            APEX_UTIL.SET_SESSION_STATE('APP_USER_ROLE', 'visitante');
            -- Opcional: registrar el error para depuración
            apex_debug.error('Error al obtener el rol del usuario %s: %s', l_username, sqlerrm);
    END;
END;</code></pre>
                    </div>
                </div>

                <div id="step-5" class="step-content">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900">Paso 5: Crear el Dashboard Dinámico</h2>
                    <p class="mb-6 text-slate-600">Ahora crearás un dashboard que muestre contenido diferente según el rol del usuario que haya iniciado sesión. Esto se logra mediante condiciones del lado del servidor.
                    </p>
                    <p class="mb-6 text-slate-600">Ve a la <strong>Página de Inicio (Home)</strong> de tu aplicación y crea una nueva **Región** para cada rol que quieras mostrar.
                    </p>
                    <div class="grid md:grid-cols-3 gap-4 mt-4 text-sm">
                        <div class="bg-slate-100 p-4 rounded-lg">
                            <h4 class="font-bold">Región Administrador</h4>
                            <p class="mt-2"><strong>Server-side Condition Type:</strong> `Item = Value`</p>
                            <p class="mt-1"><strong>Item:</strong> `APP_USER_ROLE`</p>
                            <p class="mt-1"><strong>Value:</strong> `administrador`</p>
                            <p class="mt-2">Dentro de la región, agrega el contenido que solo los administradores deben ver.</p>
                            
                        </div>
                        <div class="bg-slate-100 p-4 rounded-lg">
                            <h4 class="font-bold">Región Coach</h4>
                            <p class="mt-2"><strong>Server-side Condition Type:</strong> `Item = Value`</p>
                            <p class="mt-1"><strong>Item:</strong> `APP_USER_ROLE`</p>
                            <p class="mt-1"><strong>Value:</strong> `coach`</p>
                            <p class="mt-2">Agrega aquí el contenido específico para el rol de coach.</p>
                        </div>
                         <div class="bg-slate-100 p-4 rounded-lg">
                            <h4 class="font-bold">Región Directivo</h4>
                            <p class="mt-2"><strong>Server-side Condition Type:</strong> `Item = Value`</p>
                            <p class="mt-1"><strong>Item:</strong> `APP_USER_ROLE`</p>
                            <p class="mt-1"><strong>Value:</strong> `directivo`</p>
                            <p class="mt-2">Agrega aquí el contenido específico para el rol de directivo.</p>
                        </div>
                    </div>
                     <p class="mt-6 text-slate-600">Dentro de cada región, puedes agregar el contenido específico que desees mostrar para ese rol, como informes, gráficos o listas de tareas.</p>
                </div>

                <div id="step-6" class="step-content">
                     <h2 class="text-2xl font-bold mb-4 text-slate-900">Paso 6: Probar la Aplicación</h2>
                    <p class="mb-6 text-slate-600">¡Es hora de ver los resultados! Ejecuta la aplicación desde el **App Builder**. Serás redirigido a la página de inicio de sesión. Utiliza los datos de prueba que insertaste en el paso 2 para verificar el funcionamiento.</p>
                     <ul class="space-y-4">
                        <li class="flex items-start gap-4 p-4 bg-green-50 border-l-4 border-green-500 rounded-r-lg">
                            <div class="font-bold text-green-800">→</div>
                            <div>
                                <h4 class="font-bold text-green-900">Prueba de Administrador</h4>
                                <p class="text-green-800">Inicia sesión con `admin@test.com` y contraseña `admin123`. Deberías ver únicamente el **Dashboard de Administrador**.</p>
                            </div>
                        </li>
                         <li class="flex items-start gap-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                             <div class="font-bold text-blue-800">→</div>
                            <div>
                                <h4 class="font-bold text-blue-900">Prueba de Coach</h4>
                                <p class="text-blue-800">Cierra la sesión e inicia de nuevo con `coach@test.com` y contraseña `coach123`. Ahora solo verás el **Dashboard de Coach**.</p>
                            </div>
                        </li>
                         <li class="flex items-start gap-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg">
                             <div class="font-bold text-indigo-800">→</div>
                            <div>
                                <h4 class="font-bold text-indigo-900">Otros Roles</h4>
                                <p class="text-indigo-800">Repite el proceso para los roles de `directivo`, `aprendiz` y `visitante` para verificar que el contenido se adapta correctamente.</p>
                            </div>
                        </li>
                    </ul>
                </div>

            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const navLinks = document.querySelectorAll('.nav-link');
            const stepContents = document.querySelectorAll('.step-content');

            document.getElementById('step-navigation').addEventListener('click', function(e) {
                e.preventDefault();
                if (e.target.tagName === 'A') {
                    const step = e.target.getAttribute('data-step');

                    navLinks.forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('data-step') === step) {
                            link.classList.add('active');
                        }
                    });

                    stepContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `step-${step}`) {
                            content.classList.add('active');
                        }
                    });
                }
            });

            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const code = this.nextElementSibling.querySelector('code').innerText;
                    
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = code;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    try {
                        document.execCommand('copy');
                        this.textContent = '¡Copiado!';
                    } catch (err) {
                        console.error('Error al copiar texto: ', err);
                        this.textContent = 'Error';
                    }
                    document.body.removeChild(tempTextArea);

                    setTimeout(() => {
                        this.textContent = 'Copiar';
                    }, 2000);
                });
            });
        });
    </script>

</body>
</html>
